<?php
/*
* class Users last edit on Sat-3-Sep-2016 
*
*/
class Mdl_login extends MY_Model{
    protected $_tb_user = "users";
    protected $_order_by;

    //add $_tb_user on Thu 15 June 2017

    public $ip;

    function __construct() {
        parent::__construct();
 
        $this->ip = $this->getIP();
   }




    function getUser($where=false){
        $get = "";
        if($where):
            $get = $this->db
                    ->where($where)
                    ->get($this->_tb_user);
        else:
            $get = $this->db
                    ->order_by("date_register","DESC")
                    ->get($this->_tb_user);

        endif;
        return $get;
    }
    function uGet($where){
        
        $get = $this->getUser($where)->result();
        return $get;
    }

    function uForgot(){
        $f_email = $this->getEl("fg_email");
        $msg = "";
        $u_name = "";
        $u_email = "";
        $u_id = 0;
        $nPass = "";

        $get = $this->db
                    ->where(array("email" => $f_email))
                    ->get($this->_tb_user)->result();

        if(count($get) == 0):
            $msg = "Sorry! but we cannot find your provided email please try the new one or register";
            else:

                foreach($get as $row):
                    $u_name = $row->name;
                    $u_email = $row->email;
                    $u_id = $row->id;
                   endforeach; 
            
                $nPass = $this->randomChar(6);
                $passwd = $this->make_hash($nPass);
                //-- update table 
                    $u_data = array(
                        "passwd" => $passwd,
                        "is_activated" => 0,
                        "user_ip" => $this->ip,
                       "last_update" => $this->today 
                    );
                $our_web = site_url();

                $ac_url = site_url("login/email_active/{$passwd}");
                $m_title = "Dear {$u_name} your new password from {$our_web}";
                $m_body = "<div style='border:2px dashed #ff0000;'>
        <h1 style='text-align:center;color:green;'>ENGLISH : Dear {$u_name} you have request new password</h1>
<p>
As you request a new password on {$this->today_andTime} your new password with {$our_web} is '{$nPass}' please click <a style='color:green;font-weight:bold;' href='{$ac_url}'>here</a> within 24 hours from now (before this link going to be expire) to reactivate your account before you try to login to your account within this new password.
</p>                
<p>
<strong>PS :</strong>
if the link is not working please copy the url below then paste into your address bar and hit enter
</p>
<p style='background-color:#e7e7e7;'>
{$ac_url}
</p>
<ul>
<li>
<strong>Login Email</strong> {$u_email}
</li>
<li>
<strong>Login Password</strong> {$nPass}
</li>

</ul>
<p style='border:2px dotted #ff0000;margin:0 auto;'>
this is an automatically e-mail generated by the script please <strong>DO NOT</strong> reply to this e-mail. <br>if you need any help for this please sent e-mail to <br> <strong>admin@see-southern.com</strong> or <strong>info@see-southern.com</strong>
</p>
<p style='text-align:right;color:blue;font-weight:bold;'>With kind regards</p>
<p>&nbsp;</p>
 <h1 style='text-align:center;color:green;'>THAI : รายละเอียด การร้องขอรหัสผ่านของท่าน  {$u_name} </h1>
<p>
ตามที่ท่านมีความประสงค์ให้ ตั้งรหัสผ่านใหม่ เมื่อ {$this->today_andTime} รหัสผ่านใหม่ของท่านในการเข้าใช้งานเวป  {$our_web} คือ '{$nPass}' ก่อนที่ท่านจะล๊อคอิน โปรดคลิก <a style='color:green;font-weight:bold;' href='{$ac_url}'>ที่นี่</a> ภายใน 24 ชั่วโมง เพื่อทำการเปิดใช้งานบัญชีของท่านอีกครั้ง
</p>                
<p>
<strong>ถ้าหาก :</strong>
หากไม่สามารถคลิกลิ้งค์ด้านบนได้ กรุณา copy ลิ้งค์ด้านล่างไปวางใน address bar จากนั้นเคาะ Enter
</p>
<p style='background-color:#e7e7e7;'>
{$ac_url}
</p>
<ul>



<ul>
<li>
<strong>ลอคอินอีเมล</strong> {$u_email}
</li>
<li>
<strong>รหัสผ่าน</strong> {$nPass}
</li>

</ul>
<p style='border:2px dotted #ff0000;margin:0 auto;'>
 นี่คืออี-เมลที่สร้างขึ้นโดยระบบ โปรดอย่าตอบกลับใดๆ ทางอีเมลนี้ หากท่านต้องการความช่วยเหลือ โปรดส่งอีเมลมาที่เมลด้านล่าง <br> <strong>admin@see-southern.com</strong> or <strong>info@see-southern.com</strong>
</p>

<p style='text-align:right;color:blue;font-weight:bold;'>ด้วยความเคารพอย่างสูง</p>

    </div>";

            $this->sendMailTo(null,$u_email,$m_title,$m_body);

                    $this->SAVE($u_data,$this->_tb_user,array("id" => $u_id));

                $msg = "Success! please check your email @{$f_email} name is {$u_name} your new pass is {$nPass}";
            
           endif; 



       // $msg = "We send the reset link to your e-mail @{$f_email} please check your e-mail";
        $r_data = array(
            "msg" => $msg
        );

        return $r_data;
    }

    function active_user($where){
        $u_id = 0;
        $get = $this->uGet($where);
        foreach($get as $row):
            $u_id = $row->id;

            endforeach;
            $up_data = array(
                "is_activated" => 1 
            );
            $this->SAVE($up_data,$this->_tb_user,array("id" => $u_id));
    }


}//end class

